<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×˜×•×¤×¡ ×©×œ×™×—×ª ×¤×•×¡×˜</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://js.puter.com/v2/"></script>
  <link rel="stylesheet" href="index.css" />
  

  <script>
    function GetDataFromLS(){
      const savedData = JSON.parse(localStorage.getItem("postData") || "{}");
      if (savedData.email) $("#email").val(savedData.email);
      if (savedData.content) $("#content").val(savedData.content);
      if (Array.isArray(savedData.socials)) {
          savedData.socials.forEach(id => $(`#${id}`).prop("checked", true));
      }
    }

    function SaveDataToLS(){
      const email = $("#email").val();
      const content = $("#content").val();
      const socials = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.id);

      const formData = {
          email: email,
          content: content,
          socials: socials
      };
      
    const history = JSON.parse(localStorage.getItem("postHistory") || "[]");
    history.unshift(formData); // Add latest at the top
    localStorage.setItem("postHistory", JSON.stringify(history.slice(0, 4))); // Keep only 10 entries
    }

    function Validation(selectedPlatforms){
      if (selectedPlatforms.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: '×œ× × ×‘×—×¨×• ×¤×œ×˜×¤×•×¨××•×ª',
            text: '×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¤×œ×˜×¤×•×¨××” ××—×ª ×œ×¤×¨×¡×•×.',
            confirmButtonText: '××™×©×•×¨'
          });
          return -1;
        }

        const fileInput = document.getElementById('media');
        files = fileInput.files;
        const uploadedUrls = [];
        result = {};

        const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        const allowedVideoTypes = ['video/mp4'];

        let hasImage = false;
        let hasVideo = false;
        let videoCount = 0;
        let invalidFiles = [];

        for (const file of files) {
          if (allowedImageTypes.includes(file.type)) {
            hasImage = true;
          } else if (allowedVideoTypes.includes(file.type)) {
            hasVideo = true;
            videoCount++;
          } else {
            invalidFiles.push(file.name);
          }
        }

        if (invalidFiles.length > 0) {
          Swal.fire({
            icon: 'error',
            title: '×©×’×™××”',
            text: `×§×‘×¦×™× ×œ× ×—×•×§×™×™×: ${invalidFiles.join(', ')}. × ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¨×§ ×§×‘×¦×™× ××¡×•×’ mp4, jpg, jpeg, png.`,
          });
          return -1;
        }

        if (hasImage && hasVideo) {
          Swal.fire({
            icon: 'warning',
            title: '×©×’×™××”',
            text: '×œ× × ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×’× ×ª××•× ×•×ª ×•×’× ×¡×¨×˜×•× ×™× ×™×—×“. ×™×© ×œ×‘×—×•×¨ ×¡×•×’ ××“×™×” ××—×“ ×‘×œ×‘×“.',
          });
          return -1;
        }

        if (videoCount > 1) {
          Swal.fire({
            icon: 'error',
            title: '×©×’×™××”',
            text: '× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¨×§ ×¡×¨×˜×•×Ÿ ××—×“ ×‘×›×œ ×¤×¨×¡×•×.',
          });
          return -1;
        }

        if (files.length === 0) {
          Swal.fire({
            icon: 'error',
            title: '×©×’×™××”',
            text: '×™×© ×œ×”×¢×œ×•×ª ×œ×¤×—×•×ª ×§×•×‘×¥ ××—×“ ×œ×¤×•×¡×˜',
          });
          return -1;
        }
        return 0;
    }

    async function GetTempFilesUrl(){
      uploadedUrls=[];
      for (const file of files) {
          const formData = new FormData();
          formData.append('file', file);

          try {
            const response = await fetch('https://tmpfiles.org/api/v1/upload', {
              method: 'POST',
              body: formData
            });

            const data = await response.json();

            if (response.ok) {
              let downloadLink = data.data.url.replace("tmpfiles.org/", "tmpfiles.org/dl/");
              uploadedUrls.push(downloadLink);
            } else {
              console.error(`Failed to upload ${file.name}:`, data);
            }
          } catch (error) {
            console.error(`Error uploading ${file.name}:`, error);
          }
        }
        return uploadedUrls
    }

    function checkStatus(guid) {
      const intervalId = setInterval(async () => {
        try {
          const response = await fetch(`https://mediapublisherbackend.onrender.com/status/${guid}`);
          const data = await response.json();
          const status = data.status;

          // Update the loading message in the modal
          if (Swal.isVisible()) {
            Swal.getHtmlContainer().textContent = `×¡×˜×˜×•×¡ × ×•×›×—×™: ${status}`;
          }

          // Success
          if (status === "×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”") {
            clearInterval(intervalId);
            const links = data.results || [];
            Swal.fire({
              icon: 'success',
              title: 'âœ… ×”×¦×œ×—×”',
              html: renderSocialButtons(links),
              confirmButtonText: '×¡×’×•×¨'
            });

            SaveDataToLS();

          }else if(status.includes("×©×’×™××”")){
            clearInterval(intervalId);
            Swal.fire({
              icon: 'error',
              title: 'âŒ ×©×’×™××”',
              text: status,
              confirmButtonText: '×¡×’×•×¨'
            });
          }

        } catch (error) {
          clearInterval(intervalId);
          Swal.fire({
            icon: 'error',
            title: '×©×’×™××” ×‘×¨×©×ª',
            text: '×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ××ª ×”×¡×˜×˜×•×¡ ×›×¢×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.',
            confirmButtonText: '×¡×’×•×¨'
          });
        }
      }, 3000);
    }


  function renderSocialButtons(links) {
  const platforms = [
    { name: "Facebook", class: "facebook", icon: "fa-facebook-f", url: links.facebook },
    { name: "Instagram", class: "instagram", icon: "fa-instagram", url: links.instagram },
    { name: "Twitter X", class: "twitter", icon: "fa-x-twitter", url: links.twitter },
    { name: "Telegram", class: "telegram", icon: "fa-telegram-plane", url: links.telegram }
  ];

  let html = '<div class="result-buttons">';

  platforms.forEach(p => {
    const isValid = typeof p.url === 'string' && (p.url.startsWith('http://') || p.url.startsWith('https://'));

    html += `
      <a href="${isValid ? p.url : '#'}"
         class="result-button ${p.class}"
         style="${!isValid ? 'opacity: 0.5; pointer-events: none;' : ''}"
         target="_blank"
      >
        <i class="fab ${p.icon}"></i> ${p.name} ${isValid ? 'âœ…' : 'âŒ'}
      </a>
    `;
  });

  html += '</div>';
  return html;
}

    

const messages = [];

function addMessage(msg, isUser) {
  const messagesDiv = document.getElementById("messages");
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message");
  if (isUser) messageDiv.classList.add("user-message");
  messageDiv.textContent = msg;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById("input-message");
  const message = input.value.trim();

  if (message) {
    addMessage(message, true);
    messages.push({ content: message, role: 'user' });
    input.value = '';

    // Show loader
    Swal.fire({
      title: '×××ª×™×Ÿ ×œ×ª×’×•×‘×” ××”×‘×™× ×” ×”××œ××›×•×ª×™×ª...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Send message to GPT
    puter.ai.chat(messages)
      .then(response => {
        Swal.close(); // Close the loader
        addMessage(response, false);
        messages.push(response.message);
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: '×©×’×™××”',
          text: '××™×¨×¢×” ×©×’×™××” ×‘×§×‘×œ×ª ×ª×©×•×‘×” ××”×‘×•×˜. × ×¡×” ×©×•×‘.',
        });
        console.error("AI response error:", error);
      });
  }
}


function moveToPost() {
  const lastAIMessage = messages.reverse().find(msg => msg.role !== 'user');
  if (lastAIMessage && lastAIMessage.content) {
    $("#content").val(lastAIMessage.content);
    Swal.fire({
      icon: 'success',
      title: '×”×ª×©×•×‘×” ×”×•×¢×‘×¨×” ×œ×¤×•×¡×˜ âœ¨',
      showConfirmButton: false,
      timer: 1500
    });
  } else {
    Swal.fire({
      icon: 'info',
      title: '×œ× × ××¦××” ×ª×©×•×‘×”',
      text: '××™×Ÿ ×ª×©×•×‘×ª GPT ×œ×”×¢×‘×¨×”.',
    });
  }
}

// Modal open/close controls
function openChatModal() {
  document.getElementById("chatModal").style.display = "block";
}

function openImageModal() {
  document.getElementById("imageModal").style.display = "block";
}

function closeImageModal() {
  document.getElementById("imageModal").style.display = "none";
  document.getElementById("imagePrompt").value = "";
  document.getElementById("imagePreview").innerHTML = "";
}

function useLastGPTResponse() {
  const lastBotMessage = messages.slice().reverse().find(msg => msg.role !== 'user');
  if (lastBotMessage && lastBotMessage.content) {
    document.getElementById("imagePrompt").value = lastBotMessage.content;
    generateImage(lastBotMessage.content);
  } else {
    Swal.fire({
      icon: 'info',
      title: '××™×Ÿ ×ª×©×•×‘×ª GPT',
      text: '×œ× × ×™×ª×Ÿ ×œ××¦×•× ×ª×©×•×‘×” ××—×¨×•× ×” ×©×œ ×”×‘×•×˜.'
    });
  }
}

function generateImageNew() {
 prom = document.getElementById("imagePrompt").value.trim();
 generateImage(prom);
}

function generateImage(prom) {
  prom = "translate to english "+ prom;
  puter.ai.chat(prom)
      .then(response => {
        if (!response.message) {
          Swal.fire({
            icon: 'warning',
            title: '×—×¡×¨ ×ª×™××•×¨',
            text: '×× × ×”×–×Ÿ ×ª×™××•×¨ ×œ×ª××•× ×”.'
          });
          return;
        }

      Swal.fire({
        title: 'ğŸ¨ ×™×•×¦×¨ ×ª××•× ×”...',
        text: '×× × ×”××ª×Ÿ ××¡×¤×¨ ×©× ×™×•×ª',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      puter.ai.txt2img(prompt)
        .then(image => {
          Swal.close();
          const imagePreview = document.getElementById("imagePreview");
          imagePreview.innerHTML = `<img src="${image.src}" alt="AI Image" style="max-width: 100%; border: 1px solid #ccc;"/>`;
        })
        .catch(error => {
          Swal.fire({
            icon: 'error',
            title: '×©×’×™××” ×‘×™×¦×™×¨×ª ×ª××•× ×”',
            text: '×”×ª×¨×—×©×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª××•× ×”. × ×¡×” ×©×•×‘.'
          });
          console.error("Image generation error:", error);
        });

      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: '×©×’×™××”',
          text: '××™×¨×¢×” ×©×’×™××” ×‘×§×‘×œ×ª ×ª×©×•×‘×” ××”×‘×•×˜. × ×¡×” ×©×•×‘.',
        });
        console.error("AI response error:", error);
      });
}


    $(document).ready(function () {

      document.getElementById("closeChatModal").addEventListener("click", function () {
      document.getElementById("chatModal").style.display = "none";
      });

      // Optional: Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById("chatModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
          document.getElementById("hamburgerMenu").addEventListener("click", function () {
          document.getElementById("actionButtons").classList.toggle("show");
        });

      
       $("#localStorageButton").on("click", function () {
          const history = JSON.parse(localStorage.getItem("postHistory") || "[]");

          let html = `
          <h3 style="font-weight: normal; margin-top: -10px; color: #666;">×œ×—×¥ ×¢×œ ×©×•×¨×” ×›×“×™ ×œ×©×—×–×¨ ××ª ×”×¤×•×¡×˜</h3>
            <div style="max-height:300px; overflow-y:auto; text-align:right;">
              ${history.map((item, index) => `
                <div class="history-row" data-index="${index}" style="cursor:pointer; padding:10px; border-bottom:1px solid #ddd;">
                  <strong>××™××™×™×œ:</strong> ${item.email || ''}<br/>
                  <strong>×ª×•×›×Ÿ:</strong> ${item.content || ''}<br/>
                  <strong>×¨×©×ª×•×ª:</strong> ${item.socials?.join(", ") || ''}
                </div>
              `).join('')}
            </div>
          `;

          Swal.fire({
              title: '×”×™×¡×˜×•×¨×™×™×ª ×¤×•×¡×˜×™×',
              html: html,
              confirmButtonText: '×¡×’×•×¨',
              didOpen: () => {
                  document.querySelectorAll(".history-row").forEach(row => {
                      row.addEventListener("click", function () {
                          const index = this.getAttribute("data-index");
                          const selectedPost = history[index];
                          if (selectedPost) {
                              $("#email").val(selectedPost.email);
                              $("#content").val(selectedPost.content);
                              $("input[name='platforms']").prop("checked", false);
                              selectedPost.socials.forEach(id => $(`#${id}`).prop("checked", true));
                              Swal.fire({
                              icon: 'success',
                              title: '×”× ×ª×•× ×™× ×©×•×—×–×¨×•',
                              showConfirmButton: false,
                              timer: 1500,
                              timerProgressBar: true
                            });
                          }
                      });
                  });
              }
          });
      });

      $("#infoButton").on("click", function () {
        Swal.fire({
          icon: 'info',
          title: '×ª× ××™ ×©×™××•×© ×‘××ª×¨',
          html: `
            <ul style="text-align:right;">
              <li>××™×Ÿ ×œ×”×¢×œ×•×ª ×ª×•×›×Ÿ ×¤×•×’×¢× ×™ ××• ×œ× ×—×•×§×™.</li>
              <li>× ×™×ª×Ÿ ×œ×¤×¨×¡× ×¨×§ ×ª××•× ×•×ª JPG/PNG ×•×¡×¨×˜×•× ×™ MP4.</li>
              <li>×™×© ×œ×‘×—×•×¨ ×¨×§ ×¨×©×ª ×—×‘×¨×ª×™×ª ××—×ª ××• ×™×•×ª×¨.</li>
              <li>×›×œ ×©×™××•×© ××”×•×•×” ×”×¡×›××” ×œ×ª× ××™× ××œ×•.</li>
            </ul>
          `,
          confirmButtonText: '×”×‘× ×ª×™'
        });
      });

      // Preview uploads
      $("#media").on("change", function () {
        const preview = $("#previewArea").empty();
        const files = this.files;

        if (files.length > 0) {
          const carousel = $('<div class="carousel"></div>').appendTo(preview);

          Array.from(files).forEach(file => {
            const type = file.type.startsWith("image") ? "img" : "video";
            const reader = new FileReader();
            reader.onload = function (e) {
              const el = $(`<${type} ${type === "video" ? "controls" : ""} src="${e.target.result}"></${type}>`);
              carousel.append(el);
            };
            reader.readAsDataURL(file);
          });
        }
      });


      //On Submit
      document.getElementById('postForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        const publisherId = $("#password").val();
        const content = $("#content").val();
        const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);

        isValid=Validation(selectedPlatforms);
        if (isValid!=0) return;
        const uploadedUrls = await GetTempFilesUrl();
        

        const jsonToSend = {
          guid: crypto.randomUUID(),
          id: publisherId,
          postContent: content,
          files: uploadedUrls,
          platforms: selectedPlatforms
        };

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 100000);

        Swal.fire({
          title: '××¢×“×›×Ÿ ×¡×˜×˜×•×¡...',
          text: '×× × ×”××ª×Ÿ',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Begin the fetch
        fetch('https://mediapublisherbackend.onrender.com/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonToSend),
          signal: controller.signal
        })
        .then(async (response) => {
          const result = await response.json();
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            Swal.fire({
              icon: 'error',
              title: 'â±ï¸ ×—×¨×’ ××”×–××Ÿ',
              text: '×”×‘×§×©×” ×œ×©×¨×ª ×œ×§×—×” ×™×•×ª×¨ ××“×™ ×–××Ÿ. × ×¡×” ×©×•×‘.',
              confirmButtonText: '×¡×’×•×¨'
            });
          }
        })
        .finally(() => {
          clearTimeout(timeoutId);
        });
        checkStatus(jsonToSend.guid);
      });
    });
  </script>
</head>

<body>
  <div class="container">
   <!-- Hamburger Button for Mobile -->
<button class="hamburger" id="hamburgerMenu" aria-label="×ª×¤×¨×™×˜ × ×™×•×•×˜">
  â˜°
</button>

<!-- Collapsible menu for mobile -->
<div class="BTNS" id="actionButtons">
  <button type="button" class="info-btn" id="infoButton">
    <i class="fas fa-info-circle" aria-hidden="true"></i> ×ª× ××™×
  </button>
  <button type="button" class="LS-btn" id="localStorageButton">×”×¡×˜×•×¨×™×™×ª ×©×™××•×©</button>
  <button type="button" onclick="openChatModal()" class="gpt-btn" id="gpt">×‘×™× ×” ××œ×›×•×ª×™×ª ×œ× ×™×¡×•×— ×¤×•×¡×˜</button>
  <button onclick="openImageModal()" class="image-btn" id="imageBtn">
    ×‘×™× ×” ××œ×›×•×ª×™×ª ×œ×™×¦×™×¨×ª ×ª××•× ×” ×œ×¤×•×¡×˜
  </button>
</div>



    
    <h1>×˜×•×¤×¡ ×©×œ×™×—×ª ×¤×•×¡×˜</h1>
    <form id="postForm">
      <label for="email">××™××™×™×œ:</label>
      <input type="text" id="email" name="email" required />

      <label for="password">×§×•×“ ××©×ª××©:</label>
      <input type="password" id="password" name="password" required />

      <label for="content">×ª×•×›×Ÿ ×¤×•×¡×˜:</label>
      <textarea id="content" name="content" required></textarea>

      <label for="media">×§×•×‘×¥ ×ª××•× ×” ××• ×•×™×“××•:</label>
      <input type="file" id="media" name="media" accept="image/*,video/*" multiple />
 <div class="preview-area" id="previewArea"></div>
      <label>×‘×—×¨ ×¤×œ×˜×¤×•×¨××•×ª ×œ×¤×¨×¡×•×:</label>
<div class="social-checkboxes">
  <input type="checkbox" id="facebook" name="platforms" value="facebook">
  <label for="facebook" class="facebook"><i class="fab fa-facebook-f"></i> ×¤×™×™×¡×‘×•×§</label>

  <input type="checkbox" id="instagram" name="platforms" value="instagram">
  <label for="instagram" class="instagram"><i class="fab fa-instagram"></i> ××™× ×¡×˜×’×¨×</label>

  <input type="checkbox" id="twitter" name="platforms" value="twitter">
  <label for="twitter" class="twitter"><i class="fab fa-x-twitter"></i> ×˜×•×•×™×˜×¨ X</label>

  <input type="checkbox" id="telegram" name="platforms" value="telegram">
  <label for="telegram" class="telegram"><i class="fab fa-telegram-plane"></i> ×˜×œ×’×¨×</label>
</div>
      <button type="submit" class="button">×©×œ×—</button>
    </form>

    <!-- Chat Modal -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeChatModal">&times;</span>
   <div class="chat-body">
  <div id="messages" class="messages-container"></div>
  <textarea type="text" id="input-message" placeholder="×›×ª×•×‘ ×œ×‘×•×˜ ×œ×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×›×..."></textarea>
</div>
<div class="modal-footer">
  <button onclick="sendMessage()">×©×œ×—</button>
  <button onclick="moveToPost()">×”×¢×‘×¨ ××ª ×ª×©×•×‘×ª ×”×‘×•×˜ ×œ×¤×•×¡×˜</button>
</div>
  </div>
</div>

<!-- Image Generation Modal -->
<div id="imageModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeImageModal()">&times;</span>
    <h2>ğŸ¨ ×™×¦×™×¨×ª ×ª××•× ×” ×¢× ×‘×™× ×” ××œ×›×•×ª×™×ª</h2>

    <textarea id="imagePrompt" placeholder="×›×ª×•×‘ ×›××Ÿ ×ª×™××•×¨ ×œ×ª××•× ×”..." rows="4"></textarea>
    <button onclick="useLastGPTResponse()">×¦×•×¨ ×ª××•× ×” ×××œ×œ ×”×¤×•×¡×˜ ×”×§×™×™×</button>
    <br /><br />
    <button onclick="generateImageNew()">ğŸš€ ×¦×•×¨ ×ª××•× ×” ××”×ª×™××•×¨ ×œ××¢×œ×”</button>

    <div id="imagePreview" style="margin-top:20px;"></div>
  </div>
</div>


  </div>
</body>
</html>
