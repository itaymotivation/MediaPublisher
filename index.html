<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס פשוט</title>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            margin: 40px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
        }
    </style>
</head>
<body>

    <h1>טופס שליחת פוסט</h1>

    <form id="postForm">
        <label for="password">קוד משתמש:</label>
        <input type="password" id="password" name="password" required>

        <label for="content">תוכן פוסט:</label>
        <textarea id="content" name="content" rows="5" required></textarea>

        <label for="media">קובץ תמונה או וידאו:</label>
        <input type="file" id="media" name="media" accept="image/*,video/*" multiple>

        <button type="submit">שלח</button>
    </form>

    <script type="module">
document.getElementById('postForm').addEventListener('submit', function (e) {
    e.preventDefault();

    async function handleSubmit() {
        const email = document.getElementById('email').value;
        const content = document.getElementById('content').value;
        const files = document.getElementById('media').files;

         const owner = 'itaymotivation';
        const repo = 'MediaPublisher';
        const path = 'Agents.json';
        const token = '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';

        const postObject = {
                email,
                content,
                files: Array.from(files).map(f => f.name),
                date: new Date().toISOString()
            };

        await uploadToGitHub({
            owner, repo, path: `posts/${Date.now()}-post.json`, token, content: JSON.stringify(postObject), message: 'New post'
        });

        for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            const base64Content = arrayBufferToBase64(arrayBuffer);
            const mediaPath = `media/${Date.now()}-${file.name}`;

            await uploadToGitHub({
                owner, repo, path: mediaPath, token, content: base64Content, message: `Upload ${file.name}`
            });
        }

        alert('Upload complete!');
    }

    handleSubmit(); // call the async function
});


        
        $(document).ready(function () {
            const owner = 'itaymotivation';
            const repo = 'MediaPublisher';
            const path = 'Agents.json';
            const token = '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';
            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
              method: 'GET',
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
              },
            })
              .then(response => response.json())
              .then(data => {
                if (data && data.content) {
                  // Decode Base64 content
                  const fileContent = atob(data.content);
                  console.log('File content:', fileContent);
                } else {
                  console.error('No content found in response:', data);
                }
              })
              .catch(error => console.error('Error fetching file:', error));          
            });

        async function uploadToGitHub({ owner, repo, path, token, content, message }) {
    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

    const res = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
        },
        body: JSON.stringify({
            message,
            content
        })
    });

    const data = await res.json();
    if (!res.ok) {
        console.error('GitHub error:', data);
        throw new Error(data.message || 'Upload failed');
    }
    console.log('Uploaded:', path);
}

// Convert ArrayBuffer to Base64
function arrayBufferToBase64(buffer) {
    const binary = String.fromCharCode(...new Uint8Array(buffer));
    return btoa(binary);
}
    </script>

</body>
</html>
